// Konfiguration der Ausgänge
//        (Name,              Port, Bit,  Alias)
OUT_ALIAS (led1,              A,    7,    led_eingekuppelt_links)
OUT_ALIAS (led2,              A,    6,    led_eingekuppelt_rechts)
OUT_ALIAS (led3,              A,    5,    led_handbremse)
OUT_ALIAS (led4,              A,    4,    led_kappung)
OUT_ALIAS (led5,              A,    3,    led_temperatur)
OUT_ALIAS (led6,              A,    2,    led_power)
OUT       (led7,              A,    1)
OUT       (led8,              A,    0)
OUT       (buzzer,            F,    2)
OUT       (latch_aus,         B,    6)
OUT       (zuendungsfreigabe, C,    0)
OUT       (zuendungsbruecke,  C,    1) // Zündung überbrücken, wenn 1 kann Zündung nicht mehr ausgemacht werden
OUT       (system1,           C,    2)
OUT       (system2,           C,    3)
OUT       (system3,           C,    4)
OUT       (system4,           C,    5)
OUT_ALIAS (system5,           C,    6,    trommelbremse_auf)
OUT_ALIAS (system6,           C,    7,    auszugsbremse_auf)

// Konfiguration der Eingänge
//       (Name,               Port, Bit,  Alias)
IN_ALIAS (schalter1,          E,    2,    schalter_einkuppeln_links)
IN_ALIAS (schalter2,          E,    3,    schalter_einkuppeln_rechts)
IN_ALIAS (schalter3,          E,    4,    schalter_auszugsbremse_auf)
IN       (schalter4,          E,    5)
IN_ALIAS (schalter5,          E,    6,    schalter_auskuppeln)
IN       (schalter6,          B,    5)
IN_ALIAS (system1,            D,    7,    bremse_getreten)
IN_ALIAS (system2,            D,    6,    falscher_gang)
IN_ALIAS (system3,            D,    5,    drehzahl_links)
IN_ALIAS (system4,            D,    4,    drehzahl_rechts)
IN_ALIAS (system5,            D,    3,    motor_temp_zu_hoch)
IN_ALIAS (system6,            D,    2,    wandler_temp_zu_hoch)
IN_ALIAS (system7,            D,    1,    kappung_gespannt)
IN_ALIAS (system8,            D,    0,    handbremse_angezogen)
IN_ALIAS (system9,            B,    7,    motor_an)

// Zustände des Automaten
//    (Zustandsname,        Attribute)
STATE (start,               (shape=doublecircle))
STATE (bereit,              ())
STATE (motor_an,            ())
STATE (temp_ok,             ())
STATE (bremse_getreten,     ())
STATE (links_eingekuppelt,  ())
STATE (rechts_eingekuppelt, ())
STATE (schlepp_laeuft,      ())
STATE (fehler,              (color=red))
STATE (fehler_motor_an,     (color=red))
STATE (ausziehen,           ())

// Ereignisse, die Zustandsübergänge auslösen
//    (Ereignisname,     Boolescher Ausdruck)
EVENT (konfiguration_ok, in.kappung_gespannt &&
                         in.handbremse_angezogen &&
                         !in.falscher_gang)
EVENT (temp_ok,          !in.motor_temp_zu_hoch && !in.wandler_temp_zu_hoch)

// Aktionen beim Betreten eines Zustands
//     (Aktionsname,                Code-Block)
ACTION (links_einkuppeln,           {out.auszugsbremse_auf = 1;})
ACTION (rechts_einkuppeln,          {out.auszugsbremse_auf = 1;})
ACTION (auskuppeln,                 {out.auszugsbremse_auf = 0;})
ACTION (latch_ausschalten,          {out.latch_aus = 1;})
ACTION (zuendung_freigeben,         {})
ACTION (zuendung_sperren,           {})
ACTION (auszugsbremse_auf,          {out.auszugsbremse_auf = 1;})
ACTION (auszugsbremse_zu,           {out.auszugsbremse_auf = 0;})

// Übergänge zwischen Zuständen
//           (Anfangszustand,      Ereignis,                       Endzustand,          Attribute,     Aktion)
TRANS        (start,               konfiguration_ok,               bereit,              (color=green))
TRANS        (bereit,              !konfiguration_ok,              start,               (color=blue))
TRANS_ACTION (bereit,              in.schalter_auszugsbremse_auf,  ausziehen,           (),            auszugsbremse_auf)
TRANS_ACTION (bereit,              temp_ok,                        temp_ok,             (color=green), zuendung_freigeben)
TRANS_ACTION (ausziehen,           !in.schalter_auszugsbremse_auf, bereit,              (),            auszugsbremse_zu)
TRANS_ACTION (ausziehen,           !konfiguration_ok,              fehler,              (color=red),   auszugsbremse_zu)
TRANS_ACTION (temp_ok,             !temp_ok,                       bereit,              (color=blue),  zuendung_sperren)
TRANS        (temp_ok,             in.motor_an,                    motor_an,            (color=green))
TRANS        (temp_ok,             !konfiguration_ok,              fehler,              (color=red))
TRANS        (motor_an,            in.bremse_getreten,             bremse_getreten,     (color=green))
TRANS        (motor_an,            !in.motor_an,                   temp_ok,             (color=blue))
TRANS        (motor_an,            !konfiguration_ok,              fehler_motor_an,     (color=red))
TRANS        (bremse_getreten,     !in.bremse_getreten,            motor_an,            (color=blue))
TRANS_ACTION (bremse_getreten,     in.schalter_einkuppeln_links,   links_eingekuppelt,  (color=green), links_einkuppeln)
TRANS_ACTION (bremse_getreten,     in.schalter_einkuppeln_rechts,  rechts_eingekuppelt, (color=green), rechts_einkuppeln)
TRANS        (bremse_getreten,     !konfiguration_ok,              fehler_motor_an,     (color=red))
TRANS_ACTION (links_eingekuppelt,  in.schalter_auskuppeln,         bremse_getreten,     (color=blue),  auskuppeln)
TRANS_ACTION (rechts_eingekuppelt, in.schalter_auskuppeln,         bremse_getreten,     (color=blue),  auskuppeln)
TRANS_ACTION (links_eingekuppelt,  !in.bremse_getreten,            schlepp_laeuft,      (color=green), latch_ausschalten)
TRANS_ACTION (rechts_eingekuppelt, !in.bremse_getreten,            schlepp_laeuft,      (color=green), latch_ausschalten)
TRANS_ACTION (links_eingekuppelt,  !konfiguration_ok,              fehler_motor_an,     (color=blue),  auskuppeln)
TRANS_ACTION (rechts_eingekuppelt, !konfiguration_ok,              fehler_motor_an,     (color=blue),  auskuppeln)
TRANS        (fehler,              konfiguration_ok,               bereit,              ())
TRANS        (fehler_motor_an,     konfiguration_ok,               motor_an,            ())
TRANS        (fehler_motor_an,     !in.motor_an,                   fehler,              ())
