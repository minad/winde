// Konfiguration der Ausgänge
//        (Name,              Port, Bit, Alias)
OUT_ALIAS (led1,              A,    7,   led_eingekuppelt_links)
OUT_ALIAS (led2,              A,    6,   led_eingekuppelt_rechts)
OUT_ALIAS (led3,              A,    5,   led_handbremse)
OUT_ALIAS (led4,              A,    4,   led_kappung)
OUT_ALIAS (led5,              A,    3,   led_temperatur)
OUT_ALIAS (led6,              A,    2,   led_power)
OUT       (led7,              A,    1)
OUT       (led8,              A,    0)
OUT       (buzzer,            F,    2)
OUT       (latch_aus,         B,    6)
OUT       (zuendungsfreigabe, C,    0)
OUT       (zuendungsbruecke,  C,    1) // Zündung überbrücken, wenn 1 kann Zündung nicht mehr ausgemacht werden
OUT       (system1,           C,    2)
OUT       (system2,           C,    3)
OUT_ALIAS (system3,           C,    4,   einkuppeln_links)
OUT_ALIAS (system4,           C,    5,   einkuppeln_rechts)
OUT_ALIAS (system5,           C,    6,   trommelbremse_zu)
OUT_ALIAS (system6,           C,    7,   auszugsbremse_auf)

// Konfiguration der Eingänge
//       (Name,               Port, Bit, Alias)
IN_ALIAS (schalter1,          E,    2,   schalter_einkuppeln_links)
IN_ALIAS (schalter2,          E,    3,   schalter_einkuppeln_rechts)
IN_ALIAS (schalter3,          E,    4,   schalter_auszugsbremse_auf)
IN       (schalter4,          E,    5)
IN_ALIAS (schalter5,          E,    6,   schalter_auskuppeln)
IN       (schalter6,          B,    5)
IN_ALIAS (system1,            D,    7,   bremse_getreten)
IN_ALIAS (system2,            D,    6,   falscher_gang)
IN       (system3,            D,    5)
IN       (system4,            D,    4)
IN_ALIAS (system5,            D,    3,   motor_temp_zu_hoch)
IN_ALIAS (system6,            D,    2,   wandler_temp_zu_hoch)
IN_ALIAS (system7,            D,    1,   kappung_gespannt)
IN_ALIAS (system8,            D,    0,   handbremse_angezogen)
IN_ALIAS (system9,            B,    7,   motor_an)

// Zustände des Automaten
//    (Zustandsname,        Graphviz-Attribute)
STATE (start,               ())
STATE (aufbau_ok,           ())
STATE (motor_an,            ())
STATE (temp_ok,             ())
STATE (bremse_getreten,     ())
STATE (links_eingekuppelt,  ())
STATE (rechts_eingekuppelt, ())
STATE (schlepp_laeuft,      (shape=doublecircle))
STATE (fehler,              (RED))
STATE (ausziehen,           (DODGERBLUE))

// Ereignisse, die Zustandsübergänge auslösen
//    (Ereignisname,            Boolescher Ausdruck)
EVENT (aufbau_ok,               in.kappung_gespannt && in.handbremse_angezogen && !in.falscher_gang)
EVENT (temp_ok,                 !in.motor_temp_zu_hoch && !in.wandler_temp_zu_hoch)
EVENT (aufbau_ok_und_motor_an,  aufbau_ok && in.motor_an)
EVENT (aufbau_ok_und_motor_aus, aufbau_ok && !in.motor_an)

// Aktionen beim Betreten eines Zustands
//     (Aktionsname,        Code-Block)
ACTION (links_einkuppeln,   out.auszugsbremse_auf = out.einkuppeln_links = 1; out.trommelbremse_zu = 0;)
ACTION (rechts_einkuppeln,  out.auszugsbremse_auf = out.einkuppeln_rechts = 1; out.trommelbremse_zu = 0;)
ACTION (auskuppeln,         out.auszugsbremse_auf = out.einkuppeln_links = out.einkuppeln_rechts = 0; out.trommelbremse_zu = 1;)
ACTION (latch_ausschalten,  out.latch_aus = 1;)
ACTION (zuendung_freigeben, out.zuendungsfreigabe = out.trommelbremse_zu = 1;)
ACTION (zuendung_sperren,   out.zuendungsfreigabe = out.trommelbremse_zu = 0;)
ACTION (auszugsbremse_auf,  out.auszugsbremse_auf = 1; out.trommelbremse_zu = out.zuendungsfreigabe = 0;)
ACTION (auszugsbremse_zu,   out.auszugsbremse_auf = 0; out.trommelbremse_zu = 1;)

// Übergänge zwischen Zuständen
//           (Anfangszustand,      Ereignis (Boolescher Ausdurck), Endzustand,          Graphviz-Attribute,      Aktion)
TRANS        (start,               aufbau_ok,                      aufbau_ok,           (GREEN))
TRANS        (start,               !aufbau_ok,                     fehler,              (RED,constraint=false))
TRANS_ACTION (aufbau_ok,           in.schalter_auszugsbremse_auf,  ausziehen,           (DODGERBLUE),            auszugsbremse_auf)
TRANS_ACTION (aufbau_ok,           temp_ok,                        temp_ok,             (GREEN),                 zuendung_freigeben)
TRANS_ACTION (ausziehen,           !in.schalter_auszugsbremse_auf, aufbau_ok,           (DODGERBLUE),            auszugsbremse_zu)
TRANS_ACTION (ausziehen,           !aufbau_ok,                     fehler,              (RED,constraint=false),  auszugsbremse_zu)
TRANS_ACTION (temp_ok,             !temp_ok,                       aufbau_ok,           (BLUE),                  zuendung_sperren)
TRANS        (temp_ok,             in.motor_an,                    motor_an,            (GREEN))
TRANS        (temp_ok,             !aufbau_ok,                     fehler,              (RED))
TRANS_ACTION (temp_ok,             in.schalter_auszugsbremse_auf,  ausziehen,           (DODGERBLUE),            auszugsbremse_auf)
TRANS        (motor_an,            in.bremse_getreten,             bremse_getreten,     (GREEN))
TRANS        (motor_an,            !in.motor_an,                   temp_ok,             (BLUE))
TRANS        (motor_an,            !aufbau_ok,                     fehler,              (RED))
TRANS        (bremse_getreten,     !in.bremse_getreten,            motor_an,            (BLUE))
TRANS_ACTION (bremse_getreten,     in.schalter_einkuppeln_links,   links_eingekuppelt,  (GREEN),                links_einkuppeln)
TRANS_ACTION (bremse_getreten,     in.schalter_einkuppeln_rechts,  rechts_eingekuppelt, (GREEN),                rechts_einkuppeln)
TRANS        (bremse_getreten,     !aufbau_ok_und_motor_an,        fehler,              (RED,constraint=false))
TRANS_ACTION (links_eingekuppelt,  in.schalter_auskuppeln,         bremse_getreten,     (BLUE),                 auskuppeln)
TRANS_ACTION (rechts_eingekuppelt, in.schalter_auskuppeln,         bremse_getreten,     (BLUE),                 auskuppeln)
TRANS_ACTION (links_eingekuppelt,  !in.bremse_getreten,            schlepp_laeuft,      (GREEN),                latch_ausschalten)
TRANS_ACTION (rechts_eingekuppelt, !in.bremse_getreten,            schlepp_laeuft,      (GREEN),                latch_ausschalten)
TRANS_ACTION (links_eingekuppelt,  !aufbau_ok_und_motor_an,        fehler,              (RED,constraint=false), auskuppeln)
TRANS_ACTION (rechts_eingekuppelt, !aufbau_ok_und_motor_an,        fehler,              (RED,constraint=false), auskuppeln)
TRANS_ACTION (fehler,              aufbau_ok_und_motor_aus,        aufbau_ok,           (),                     zuendung_sperren)
TRANS        (fehler,              aufbau_ok_und_motor_an,         motor_an,            ())
